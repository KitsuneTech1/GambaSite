<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <script src="js/jwt-decode.min.js"></script>
    <script src="common.js"></script>
</head>
<body>
    <div class="container">
        <div id="header-placeholder"></div>
        <div class="main-content-area">
            <div id="sidebar-placeholder"></div>
            <main class="admin-container">
                <h1>Admin Panel</h1>
                <div id="admin-content">
                    <p>Verifying access...</p>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadHeader();
            loadSidebar();
            // checkAdminAccess(); // Moved to common.js after auth is handled
        });

        // Moved to common.js
        /*
        function getDecodedSteamID() {
            const token = localStorage.getItem("auth_token");
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split(".")[1]));
                return payload.steamid;
            } catch (err) {
                console.error("Failed to decode JWT:", err);
                return null;
            }
        }

        async function checkAdminAccess() {
            const authorizedSteamID = "76561199163202169"; // your admin SteamID
            const loggedInSteamID = getDecodedSteamID();

            if (!loggedInSteamID) {
                document.getElementById("admin-content").innerHTML =
                    "<p>Please log in with Steam to access the admin panel.</p>";
                return;
            }

            if (loggedInSteamID === authorizedSteamID) {
                renderAdminForm(loggedInSteamID);
            } else {
                document.getElementById("admin-content").innerHTML =
                    "<p>Access Denied: Your SteamID does not have administrative privileges.</p>";
            }
        }
        */

        function renderAdminForm(adminSteamID) {
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2>Add Balance</h2>
                <form id="add-balance-form">
                    <div class="form-group">
                        <label for="targetSteamID">Target SteamID:</label>
                        <input type="text" id="targetSteamID" name="targetSteamID" required>
                    </div>
                    <div class="form-group">
                        <label for="currency">Currency:</label>
                        <select id="currency" name="currency" required>
                            <option value="COIN">COIN</option>
                            <option value="GEM">GEM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount:</label>
                        <input type="number" id="amount" name="amount" required min="0">
                    </div>
                    <button type="submit" class="btn">Add Balance</button>
                </form>
                <div id="response-message"></div>
            `;

            document.getElementById("add-balance-form").addEventListener("submit", (e) =>
                handleAddBalanceSubmit(e, adminSteamID)
            );
        }

        async function handleAddBalanceSubmit(event, adminSteamID) {
            event.preventDefault();

            const targetSteamID = document.getElementById("targetSteamID").value;
            const currencyCode = document.getElementById("currency").value;
            const amount = parseInt(document.getElementById("amount").value);
            const responseMessageDiv = document.getElementById("response-message");
            responseMessageDiv.innerHTML = "<p>Sending request...</p>";

            try {
                const response = await fetch("https://api.tryharderapi.lol/admin/add_balance", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("auth_token")}`
                    },
                    body: JSON.stringify({
                        admin_steam_id: adminSteamID,
                        target_steam_id: targetSteamID,
                        currency_code: currencyCode,
                        amount: amount
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    responseMessageDiv.innerHTML = `<p class="success">Success: ${result.message || "Balance added successfully."}</p>`;
                } else {
                    responseMessageDiv.innerHTML = `<p class="error">Error: ${result.message || "Failed to add balance."}</p>`;
                }
            } catch (error) {
                console.error("Error adding balance:", error);
                responseMessageDiv.innerHTML = `<p class="error">An unexpected error occurred: ${error.message}</p>`;
            }
        }
    </script>
</body>
