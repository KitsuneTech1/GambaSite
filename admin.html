<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <script src="common.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <div id="header-placeholder"></div>
    <div id="sidebar-placeholder"></div>

    <main class="admin-container">
        <h1>Admin Panel</h1>
        <div id="admin-content">
            <p>Verifying access...</p>
        </div>
    </main>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            loadHeader();
            loadSidebar();
            checkAdminAccess();
        });

        async function checkAdminAccess() {
            const steamID = localStorage.getItem("auth_token");
            const authorizedSteamID = "76561199163202169";

            if (!steamID) {
                document.getElementById("admin-content").innerHTML = "<p>Please log in with Steam to access the admin panel.</p>";
                return;
            }

            // In a real application, you would likely decode the steam_auth_token to get the SteamID
            // For this example, we'll assume the cookie *is* the SteamID or can be easily parsed.
            // If the cookie is a JWT or similar, you'd need a library to decode it on the client-side
            // or a server-side endpoint to validate and return the SteamID.

            // For now, let's simulate getting the SteamID from the cookie.
            // This is a placeholder and needs to be replaced with actual logic to extract SteamID from your auth token.
            let loggedInSteamID = null;
            if (steamID) {
                try {
                    const payload = JSON.parse(atob(steamID.split(".")[1]));
                    loggedInSteamID = payload.steamid;
                } catch (e) {
                    console.error("Error decoding auth token:", e);
                }
            }

            if (loggedInSteamID === authorizedSteamID) {
                renderAdminForm();
            } else {
                document.getElementById("admin-content").innerHTML = "<p>Access Denied: Your SteamID does not have administrative privileges.</p>";
            }
        }

        function renderAdminForm() {
            const adminContent = document.getElementById("admin-content");
            adminContent.innerHTML = `
                <h2>Add Balance</h2>
                <form id="add-balance-form">
                    <div class="form-group">
                        <label for="targetSteamID">Target SteamID:</label>
                        <input type="text" id="targetSteamID" name="targetSteamID" required>
                    </div>
                    <div class="form-group">
                        <label for="currency">Currency:</label>
                        <select id="currency" name="currency" required>
                            <option value="COIN">COIN</option>
                            <option value="GEM">GEM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="amount">Amount:</label>
                        <input type="number" id="amount" name="amount" required min="0">
                    </div>
                    <button type="submit" class="btn">Add Balance</button>
                </form>
                <div id="response-message"></div>
            `;

            document.getElementById("add-balance-form").addEventListener("submit", handleAddBalanceSubmit);
        }

        async function handleAddBalanceSubmit(event) {
            event.preventDefault();

            let adminSteamID = null;
            const authToken = localStorage.getItem("auth_token");
            if (authToken) {
                try {
                    const payload = JSON.parse(atob(authToken.split(".")[1]));
                    adminSteamID = payload.steamid;
                } catch (e) {
                    console.error("Error decoding auth token:", e);
                }
            }
            const targetSteamID = document.getElementById("targetSteamID").value;
            const currencyCode = document.getElementById("currency").value;
            const amount = parseInt(document.getElementById("amount").value);

            const responseMessageDiv = document.getElementById("response-message");
            responseMessageDiv.innerHTML = "<p>Sending request...</p>";

            try {
                const response = await fetch("https://api.tryharderapi.lol/admin/add_balance", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${adminSteamID}` // Assuming the token is a bearer token
                    },
                    body: JSON.stringify({
                        admin_steam_id: adminSteamID, // This should ideally come from a decoded token
                        target_steam_id: targetSteamID,
                        currency_code: currencyCode,
                        amount: amount
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    responseMessageDiv.innerHTML = `<p class="success">Success: ${result.message || "Balance added successfully."}</p>`;
                } else {
                    responseMessageDiv.innerHTML = `<p class="error">Error: ${result.message || "Failed to add balance."}</p>`;
                }
            } catch (error) {
                console.error("Error adding balance:", error);
                responseMessageDiv.innerHTML = `<p class="error">An unexpected error occurred: ${error.message}</p>`;
            }
        }

        // Helper function to get cookie value (from common.js or auth.js if it exists there)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
            return null;
        }
    </script>
</body>
</html>
